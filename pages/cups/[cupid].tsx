import type { NextPage } from "next";
import Head from "next/head";
import styles from "../../styles/CupDetails.module.css";
import React, { useState, useEffect, useContext } from "react";
import { useRouter } from "next/router";
import { UserContext } from "../../context/UserProvider";
import JoinCupDialog from "../../Components/JoinCupDialog";
import moment from "moment";
import { db } from "../../config/firebase.config";
import { getDoc, doc, Timestamp } from "firebase/firestore";
import { Icon } from '@iconify/react';

const CupDetails: NextPage = () => {
  const router = useRouter();
  const [loading, setLoading] = useState<boolean>(true);
  const [cupid] = useState(router.asPath.substring(1).split("/")[1]);
  const [imageURL, setImageURL] = useState("");
  const [name, setName] = useState("");
  const [cupType, setCupType] = useState("");
  const [director, setDirector] = useState("");
  const [buyIn, setBuyIn] = useState(0);
  const [startDate, setStartDate] = useState(Timestamp.now());
  const [endDate, setEndDate] = useState(Timestamp.now());
  const [joinedUser, setJoinedUser] = useState(false);
  const [usd, setUsd] = useState(0);
  const {
    query: { id },
  } = router;
  const user = useContext(UserContext);

  const getCups = async () => {
    const cupDocRef = doc(db, "cups", cupid);
    const cupDocSnap = await getDoc(cupDocRef);
    if (cupDocSnap.exists()) {
      const data = cupDocSnap.data();
      setImageURL(data.imageURL);
      setName(data.name);
      setCupType(data.cupType);
      const userDocRef = doc(db, "users", data.director);
      const userDocSnap = await getDoc(userDocRef);
      if (userDocSnap.exists()) {
        const userData = userDocSnap.data();
        setDirector(userData.firstName+" "+userData.lastName);
      }
      setBuyIn(data.buyIn);
      setStartDate(data.startDate);
      setEndDate(data.endDate);
      if (user.uid in data.userPortfolios){
        setJoinedUser(true);
        setUsd(data.userPortfolios[user.uid]["usd"]);
      }
    }
    setLoading(false);      
  };

  useEffect(() => {
    getCups();
    // setTimeout( () => {
    //     setLoading(false);
    //   },2000)
  }, []);

  return (
    <div>
      <Head>
        <title>CupDetails</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <img className={styles.placeholder} src={imageURL}></img>
      <div className={styles.container}>
      {loading ? (
        <p>loading</p>
      ) : (
        <div>
          <h5 className={styles.name}>{name}</h5>
          <div className={styles.cuptype}>{cupType}</div>
          <h6 className={styles.commis}>Cup Commissioner: {director}</h6>
          <h6 className={styles.buyin}>Buy-In: {buyIn} ETH</h6>
          <h6 className={styles.date}>
            {moment(startDate.toDate()).format("M/D/YYYY")}&nbsp;-&nbsp;
            {moment(endDate.toDate()).format("M/D/YYYY")}
          </h6>
        {!joinedUser ? (
          <div className={styles.center}>
            <h4 className={styles.joinnow}>
              This Cup is currently accepting players. Join now!
            </h4>
            <div>
              <JoinCupDialog cup={{ name, id: cupid, buyIn }} />
            </div>
          </div>
          ) : (
            <div>
              <h5 className={styles.cupwallet}>Your Cup Wallet:</h5>
              <div className={styles.walleticon}>
                <Icon icon="cryptocurrency:usd" color="#83bd67" width="30" height="30" />
                <h6 className={styles.walletmoney}>{usd} USD</h6>
              </div>
              <h6 className={styles.asd}>Total: $123.12 USD</h6>
              <h4 className={styles.ogbudget}>(Original budget: $123.12 USD)</h4>
            </div>
          )}
          </div>
        )}
      </div>
    </div>
  );
};

export default CupDetails;
